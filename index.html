<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - adaptive tone-mapping</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				background:#000;
				color:#fff;
				padding:0;
				margin:0;
				overflow:hidden;
				font-family:georgia;
				text-align:center;
			}
			h1 { }
			a { color:skyblue; text-decoration:none }
			canvas { pointer-events:none; z-index:0; position:relative; }
			.label { background-color: black; position: absolute; z-index: 100; padding: 5px }
		</style>
	</head>

	<body>


		<script src="js/three.js"></script>
		<script src="js/Detector.js"></script>
		<script src="js/dat.gui.min.js"></script>		
		<script src="js/OrbitControls.js"></script>		
		<script src="js/stats.min.js"></script>		

		<script src="js/CopyShader.js"></script>
		<script src="js/DigitalGlitch.js"></script>
		<script src="js/EffectComposer.js"></script>
		<script src="js/RenderPass.js"></script>
		<script src="js/MaskPass.js"></script>
		<script src="js/ShaderPass.js"></script>
		<script src="js/GlitchPass.js"></script>
		
		<script src="js/FilmShader.js"></script>
		<script src="js/FilmPass.js"></script>
		<script src="js/VignetteShader.js"></script>
		<script src="js/TexturePass.js"></script>
		


		<script>
			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();
			
			var container, scene, camera, render3D;
			var width = window.innerWidth;
			var height = window.innerHeight;			
			var controls;
			
			var flare, textureFlare0, textureFlare2, textureFlare3;
			var sphere, i_earth, i_bump, i_specular;
			var clouds, i_clouds;
			var luna, moon, m_bump, m_specular;
			
			var skyBox, mapSky;
			
			var stats;
			
			var composer, effectFilm, effectVignette, glitchPass, effectFilm;
			
			var mouseX, mouseY;

			

			resIntro();	
			
			
			
			function resIntro() {
				var count = 0;
				var count_res = 11;
				
				i_clouds = loadIMG("js/earth_clouds_2048.png");				
				i_earth = loadIMG("js/earth.jpg");				
				i_bump = loadIMG("js/bump.jpg");				
				i_specular = loadIMG("js/specular.jpg");
				moon = loadIMG("js/moon_map.jpg");
				m_bump = loadIMG("js/moon_bump.jpg");
				m_specular = loadIMG("js/moon_specular.jpg");
				textureFlare0 = loadIMG("js/flare72.png");
				textureFlare2 = loadIMG("js/lensflare2.png");
				textureFlare3 = loadIMG("js/lensflare3.png");
				mapSky = loadIMG("js/fon-star2.jpg");
				
				
				function loadIMG(url) {					
					return new THREE.TextureLoader().load(
						url,
						function() {
							count++;
							if(count==count_res) initScene();
						}
					);						
				}
			}
			
			
			
			function initScene() {
				
				// *** Основной код ***
				
				// создаём исполняемый элемент контейнер и добавляем его в html документ
				container = document.createElement( 'div' );
				document.body.appendChild( container );				
				
				// создаём сцену
				scene = new THREE.Scene();
				
				// создаём камеру
				camera = new THREE.PerspectiveCamera(45, width / height, 0.01, 101000);
				camera.position.z = 4180;
				
				// добавляем управление камерой
				//controls = new THREE.OrbitControls( camera );
				//controls.autoRotate = true;
				//controls.autoRotateSpeed = 1;
								
				// создаем рендерный движок и задаем ему параметры
				render3D = new THREE.WebGLRenderer( { antialias: true, alpha: true } );
				render3D.setPixelRatio( window.devicePixelRatio );
				render3D.setSize( width, height );				
				render3D.autoClear = false;
				render3D.gammaInput = true;
				render3D.gammaOutput = true;
				container.appendChild(render3D.domElement);
								
				initObject(); // инициализация объектов сцены
				initEffect(); // добавление эффектов рендера при отображении
				renderIntro(); // рендер сцены
				
				// *** Конец основного кода ***
								
			}
			
			
			
			function initObject() {
				
				// *** Основной код ***
				
				// создаем источник освещения DirectionalLight
				var light = new THREE.DirectionalLight(0xffffff, 1);
				light.position.set(0, 0, -30000);
				light.color.setHSL( 0.618, 0.45, 1.0 );
				scene.add(light);
				
				// создаем источник освещения AmbientLight
				var ambient = new THREE.AmbientLight( 0x101010 );
				scene.add( ambient );				
				
				// создаём блики камеры
				flare = addFlare( 0.618, 0.45, 1.0, 0, 0, -30000 );
				scene.add( flare );
				
				// создем сферу Земли				
				sphere = createSphere(600, 64, i_earth, i_bump, i_specular, 100, '#343434');
				sphere.rotation.y = 6; 
				scene.add(sphere);
				
				// создем сферу облков
				clouds = createClouds(600, 64, i_clouds);
				clouds.rotation.y = 6;
				scene.add(clouds);
				
				// создаем луну
				luna = createSphere(500, 64, moon, m_bump, m_specular, 10, '#000000');
				luna.position.set(1618, 1000, -2000);
				scene.add(luna);
				
				// создаём скайбокс
				skyBox = addSkyBox(62000, 7, 'sphere', null, mapSky, mapSky, mapSky, mapSky, mapSky, mapSky);
				scene.add(skyBox);
				
				// добавляем в контейнер параметры отображения статистики (фпс, миллисекунды на кадр и ...)
				stats = new Stats();
				container.appendChild( stats.domElement );
				
				// *** Конец основного кода ***
				
				
				// *** Неосновной код, содержащий используемые функции в данной процедуре ***
				
				function addFlare( h, s, l, x, y, z ) {
					var flareColor = new THREE.Color( 0xffffff );
					flareColor.setHSL( h, s, l );
					var lensFlare = new THREE.LensFlare( textureFlare0, 512, 0.01, THREE.AdditiveBlending, flareColor );
					lensFlare.add( textureFlare2, 512, 0.0, THREE.AdditiveBlending );
					lensFlare.add( textureFlare2, 512, 0.0, THREE.AdditiveBlending );
					lensFlare.add( textureFlare2, 512, 0.0, THREE.AdditiveBlending );
					lensFlare.add( textureFlare3, 60, 0.6, THREE.AdditiveBlending );
					lensFlare.add( textureFlare3, 70, 0.7, THREE.AdditiveBlending );
					lensFlare.add( textureFlare3, 120, 0.9, THREE.AdditiveBlending );
					lensFlare.add( textureFlare3, 70, 1.0, THREE.AdditiveBlending );
					lensFlare.customUpdateCallback = lensFlareUpdateCallback;
					lensFlare.position.set( x, y, z );
					return lensFlare;					
				}
				
				function lensFlareUpdateCallback( object ) {
					var f, fl = object.lensFlares.length;
					var flare;
					var vecX = -object.positionScreen.x * 2;
					var vecY = -object.positionScreen.y * 2;
					for( f = 0; f < fl; f++ ) {
						flare = object.lensFlares[ f ];
						flare.x = object.positionScreen.x + vecX * flare.distance;
						flare.y = object.positionScreen.y + vecY * flare.distance;
						flare.rotation = 0;
					}
					object.lensFlares[ 2 ].y += 0.025;
					object.lensFlares[ 3 ].rotation = object.positionScreen.x * 0.5 + THREE.Math.degToRad( 45 );
				}
								
				function createSphere(radius, segments, map, bump, specular, b, colory) {
					return new THREE.Mesh(
						new THREE.SphereGeometry(radius, segments, segments),
						new THREE.MeshPhongMaterial({
							map:         map,
							bumpMap:     bump,
							bumpScale:   b,
							specularMap: specular,
							specular:    new THREE.Color(colory),				
						})
					);
				}
				
				function createClouds(radius, segments, map) {
					return new THREE.Mesh(
						new THREE.SphereGeometry(radius + 2, segments, segments),			
						new THREE.MeshLambertMaterial({
							map: map,
							color: 0xffffff,
							blending: THREE.NormalBlending,
							transparent: true,
							depthTest: false,							
							needsUpdate: true
						})
					);		
				}
				
				function addSkyBox(zoom, segment, type, colory, px, nx, py, ny, pz, nz) {
					var skyMat = [px, nx, py, ny, pz, nz];
					var materials = [];
					if (colory==null) colory=0xffffff;
					for ( var i = 0; i < 6; i ++ ) {
						materials.push( new THREE.MeshBasicMaterial( {
							map: skyMat[ i ],
							color: colory
						} ) );
					}				
					var skyBox = new THREE.Mesh( new THREE.CubeGeometry( zoom, zoom, zoom, segment, segment, segment ), new THREE.MeshFaceMaterial( materials ) );
					skyBox.applyMatrix( new THREE.Matrix4().makeScale( 1, 1, - 1 ) );
					if (type=='cube') return skyBox;
					if (type=='sphere') {
						for ( var i = 0, l = skyBox.geometry.vertices.length; i < l; i ++ ) {
							var vertex = skyBox.geometry.vertices[ i ];
							vertex.normalize();
							vertex.multiplyScalar( zoom );
						}
						return skyBox;
					}
					return null;				
				}
				
				// *** Конец неосновного кода ***
				
			}
			
			
			
			function initEffect() {
			
				// *** Основной код ***
				
				// задаём параметры EffectComposer-а
				var rtParameters = {
					minFilter: THREE.LinearFilter,
					magFilter: THREE.LinearFilter,
					format: THREE.RGBAFormat,
					stencilBuffer: true
				};
				
				// создаем композёр (для добавления различных эффектов)
				composer = new THREE.EffectComposer( render3D, new THREE.WebGLRenderTarget( width, height, rtParameters )  );
								
				// создаём эффект для композёра Vignette
				var shaderVignette = THREE.VignetteShader;
				effectVignette = new THREE.ShaderPass( shaderVignette );
				effectVignette.uniforms[ "offset" ].value = 0.95;
				effectVignette.uniforms[ "darkness" ].value = 1.6;
				effectVignette.renderToScreen = false;
				
				// создаём эффект для композёра Film
				effectFilm = new THREE.FilmPass( 0.35, 0.5, 2048, false );
				effectFilm.renderToScreen = false;				
								
				// создаём эффект для композёра Glitch
				glitchPass = new THREE.GlitchPass();
				glitchPass.goWild = false;
				glitchPass.renderToScreen = true; // истина задается последнему отрисовываему эффекту, который рендрит все предыдущие
				
				// добавляем созданные эффекты в композёр, начиная с рендринга сцены
				composer.addPass( new THREE.RenderPass( scene, camera ) );				
				composer.addPass( effectFilm );	
				composer.addPass( effectVignette );				
				composer.addPass( glitchPass );
				
				// *** Конец основного кода ***
				
			}
			
			
			
			function renderIntro() {
				
				// *** Основной код ***
				
				// слушатель события - движение мыши
				//document.addEventListener( 'mousemove', onDocumentMouseMove, false );
				
				// слушатель события - изменения размера экрана отображения
				window.addEventListener( 'resize', onWindowResize, false );
					
				// вызывает функцию - рендер - которая запускает рендер сцены и исполняет её код				
				render();
				
				// *** Конец основного кода ***
				
				
				// *** Неосновной код, содержащий используемые функции в данной процедуре ***
				
				function render() {
					requestAnimationFrame(render);
					animate(); // код сцены, который исполняется во время рендринга
					composer.render(0.7);					
				}
				
				function animate() {
					//controls.update();
					camera.lookAt( scene.position );
					stats.update();
					//camera.position.x += ( mouseX - camera.position.x ) * .05;
					sphere.rotation.y += 0.0003;
					clouds.rotation.y += 0.0006;
					skyBox.rotation.z += 0.0003;
					skyBox.rotation.x += 0.0002;
				}
				
				function onWindowResize() {
					width = window.innerWidth;
					height = window.innerHeight;
					camera.aspect = width / height;
					camera.updateProjectionMatrix();
					render3D.setSize( width, height );
					composer.setSize( width, height );					
				}
				
				function onDocumentMouseMove( event ) {
					mouseX = ( event.clientX - width / 2 ) / 2;
					mouseY = ( event.clientY - height / 2 ) / 2;
				}
				
				// *** Конец неосновного кода ***
				
			}
		</script>

	</body>
</html>		
