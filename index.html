<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - adaptive tone-mapping</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				background:#000;
				color:#fff;
				padding:0;
				margin:0;
				overflow:hidden;
				font-family:georgia;
				text-align:center;
			}
			h1 { }
			a { color:skyblue; text-decoration:none }
			canvas { pointer-events:none; z-index:0; position:relative; }
			.label { background-color: black; position: absolute; z-index: 100; padding: 5px }
		</style>
	</head>

	<body>


		<script src="js/three.js"></script>
		
		

		<script src="js/Detector.js"></script>
		<script src="js/dat.gui.min.js"></script>

		

		
		<script src="js/OrbitControls.js"></script>
		
		<script src="js/stats.min.js"></script>
		
		

		<script>
			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

			var width = window.innerWidth,
				height = window.innerHeight,
				radius   = 600,
				segments = 64,
				rotation = 6,
				stats;
			
			var i_clouds,
			    i_earth,
			    i_bump,
			    i_specular;
			

			resIntro();
			
			function resIntro() {
				var count = 0;
				i_clouds = loadIMG("js/earth_clouds_2048.png");
				console.log('/1 count is ', count);
				i_earth = loadIMG("js/earth.jpg");
				console.log('/2 count is ', count);
				i_bump = loadIMG("js/bump.jpg");
				console.log('/3 count is ', count);
				i_specular = loadIMG("js/specular.jpg");
				console.log('/4 count is ', count);
				
				
				function loadIMG(url) {
					console.log('start ', url);
					return new THREE.TextureLoader().load(
						url,
						function() {
							console.log('loaded ' + url);
							count++;
						},
						function() {console.log('... ' + url);},
						function() {console.log('error ' + url);},
					);						
				}
			}
				
			function Intro() {
				
				// СОЗДАЕМ КОНТЕЙНЕР
				container = document.createElement( 'div' );
				document.body.appendChild( container );
				
				// СОЗДАЕМ СЦЕНУ И КАМЕРУ
				var scene = new THREE.Scene();
				var camera = new THREE.PerspectiveCamera(45, width / height, 0.01, 101000);
				camera.position.z = 6300;
				
				// СОЗДАЕМ РЕНДЕРНЫЙ ДВИЖОК И ДОБАВЛЯЕМ ЕГО В КОНТЕЙНЕР
				render3D = new THREE.WebGLRenderer( { antialias: true, alpha: true } );
				render3D.setPixelRatio( window.devicePixelRatio );
				render3D.setSize( window.innerWidth, window.innerHeight );				
				render3D.autoClear = false;
				render3D.gammaInput = true;
				render3D.gammaOutput = true;
				container.appendChild(render3D.domElement);
				
				// СОЗДАЕМ ИСТОЧНИК ОСВЕЩЕНИЯ
				var light = new THREE.DirectionalLight(0xffffff, 1);
				light.position.set(0,0,-5000);
				light.color.setHSL( 0.618, 0.45, 1.0 );
				scene.add(light);
				
				// Создаем землю -----------------------------------------------------------------------
				// Создем сферу Земли				
				var textureLoader = new THREE.TextureLoader();
				var sphere = createSphere(radius, segments);
				function createSphere(radius, segments) {
					return new THREE.Mesh(
						new THREE.SphereGeometry(radius, segments, segments),
						new THREE.MeshPhongMaterial({
							map:         i_earth,
							bumpMap:     i_bump,
							bumpScale:   10,
							specularMap: i_specular,
							specular:    new THREE.Color('#343434'),				
						})
					);
				}
				sphere.rotation.y = rotation; 
				scene.add(sphere);
				// Создем сферу облков
				var clouds = createClouds(radius, segments);
				function createClouds(radius, segments) {
					return new THREE.Mesh(
						new THREE.SphereGeometry(radius + 2, segments, segments),			
						new THREE.MeshLambertMaterial({
							map: i_clouds,
							color: 0xffffff,
							blending: THREE.NormalBlending,
							transparent: true,
							depthTest: false,							
							needsUpdate: true
						})
					);		
				}
				clouds.rotation.y = rotation;
				scene.add(clouds);
				// Создание Земли окончено -------------------------------------------------------------
								
				// ДОБАВЛЯЕМ УПРАВЛЕНИЕ КАМЕРОЙ
				controls = new THREE.OrbitControls( camera );
				controls.autoRotate = true;
				controls.autoRotateSpeed = 1;
				
				// Прочие данные
				var rotY = 0.0003;
				var rotY2 = 0.0005;
				
				window.addEventListener( 'resize', onWindowResize, false );
				render();
				
				// РЕНДРИМ
				function render() {
					requestAnimationFrame(render);
					controls.update();
					// stats.update();
					sphere.rotation.y += rotY;
					clouds.rotation.y += rotY2;
					clouds.rotation.z += 0.0005;	
					render3D.render(scene, camera);
				}
				function onWindowResize() {					
					camera.aspect = window.innerWidth / window.innerHeight;
					camera.updateProjectionMatrix();
					render3D.setSize( window.innerWidth, window.innerHeight );
				}
			}
		</script>

	</body>
</html>		
